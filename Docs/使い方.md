# MaskMaker 使い方（Unity 2022.3）

このドキュメントは、**MaskMaker** (`Tools > MaskMaker`) の使い方を説明します。Unityエディタ上でメッシュのUVアイランドを視覚的に選択し、マスク画像（PNG）や頂点カラーとして書き出すことができるツールです。

---

## 主な機能
- **UVアイランド選択**: シーンビューで直接メッシュをクリックして選択。
- **Work Copy機能（自動）**: メッシュ変形による位置ズレを防ぐため、自動的に作業用の静的コピーを作成して操作できます。
- **柔軟な書き出し**: チャンネル別書き込み（RGBA）、頂点カラーへの焼き込みに対応。
- **インポート設定自動化**: 書き出したテクスチャは自動的に `Read/Write Enabled` と `Streaming Mipmaps` が有効になります。

---

## 基本手順
1. メニューから `Tools > MaskMaker` を開く。
2. ウィンドウ上部の `Target Model` 枠に対象 GameObject をドラッグ＆ドロップ（または Object フィールドで指定）。
   - **ワークコピー**: デフォルトでは、位置ズレ防止用の作業用コピー（`[WorkCopy]`）が作成され、シーンに表示されます。
3. `Edit Mode` で `Add`（選択）または `Remove`（解除）を選択。
   - ホットキー（デフォルト `R`）でモード切替が可能。
4. シーンビューのメッシュまたは `UV Preview` をクリックしてアイランドを選択。
5. `Selection Actions` の `Analyze UVs` をクリックして UV の解析を実行（初回や設定変更時）。
6. `Quick Export` セクションで設定を確認し、`Save PNG` でマスクを書き出し。

---

## 各セクションの説明

### 1. Target Model（対象モデル）
- **Object**: 対象となる MeshRenderer または SkinnedMeshRenderer を含む GameObject。
- **ワークコピーを作成 / コピーを削除して戻る**:
  - メッシュ変形（Modular Avatar等）の影響を受けない作業用の複製を作成します。
  - 元のオブジェクトは非表示になり、作業が終わって「削除して戻る」を押すと元の状態に復元されます。

### 2. Edit Mode（編集モード）
- **Add / Remove**: クリック時の基本動作を切り替えます。
- **ホットキー**: 初期設定では `R` キーでこのモードを素早く切り替えられます（環境設定で変更可能）。

### 3. UV Preview（プレビュー）
- 解析されたUVが表示されます。
- ここを直接クリックしてアイランドを選択・解除することも可能です。

### 4. Selection Actions（選択操作）
- **Analyze UVs**: UVレイアウトを解析します。対象やUVチャンネルを変更した際に実行してください。
- **Invert / Select All / Clear**: 選択の反転、全選択、全解除を行います。

### 5. Quick Export（クイックエクスポート）
- **Resolution**: 出力テクスチャサイズ。
- **マスク反転**: 黒（不透明）と白（透明）を最終的に入れ替えます。
- **ピクセルマージン**: UVシーム付近の滲みを防ぐため、黒領域を数ピクセル膨張させます。
- **Save PNG**: マスク画像を保存します。

### 6. Output Settings（出力設定 - 折りたたみ）
- **File Name**: 出力ファイル名（拡張子なし）。
- **Output Folder**: 保存先フォルダ（ドロップで指定可能）。
- **メインテクスチャのフォルダを使用**: チェックを入れると、モデルのテクスチャと同じ場所に保存します。
- **反転マスクも同時に保存**: 通常のマスクに加えて `_inv.png` を同時出力します。

### 7. 詳細オプション（折りたたみ）
- **🎨 Scene Overlay**: シーンビューでの表示（ラインの太さ、色、Zファイティング対策など）。
- **📝 Channel Write**: RGBAの特定のチャンネルにのみマスクを書き込む設定。既存PNGの上書きも可能です。
- **🎯 Vertex Color Bake**: 選択範囲を頂点カラーとしてメッシュに焼き込み、新規アセットとして保存します。
- **⚙️ 環境設定**: 言語切り替え、ホットキー設定、ワークコピーの初期設定など。

---

## トラブルシューティング

**Q. メッシュをクリックしても反応しない**
- 対象オブジェクトが正しく設定されているか確認してください。
- 作業用コピーを使っていない場合、コライダーが正しく生成されていない可能性があります。一度 `Analyze UVs` を押し直してみてください。
- また、メッシュの裏面からのクリックには反応しません。シェーダーが両面描画になっている場合も表面をクリックしてください。

**Q. SkinnedMeshRendererで表示と判定がズレる**
- `Auto Work Copy` が有効（デフォルト）であれば、静的なコピーが作られるためズレは発生しません。
- Work Copyを使わない場合（設定OFF時）でも、内部的に現在のポーズに合わせた判定を行いますが、極端な変形がある場合はWork Copyの利用を推奨します。

**Q. マスク画像がぼやけている / UVの境界で色が滲む**
- `Pixel Margin` の値を調整してください（デフォルト 2px）。黒領域をわずかに拡張してUVの隙間を埋めます。

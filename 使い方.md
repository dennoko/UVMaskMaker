# MaskMaker 使い方（Unity 2022.3）

このドキュメントは、**MaskMaker** (`Tools > MaskMaker`) の使い方を説明します。Unityエディタ上でメッシュのUVアイランドを視覚的に選択し、マスク画像（PNG）や頂点カラーとして書き出すことができるツールです。

---

## 主な機能
- **UVアイランド選択**: シーンビューで直接メッシュをクリックして選択。
- **Work Copy機能（自動）**: メッシュ変形による位置ズレを防ぐため、自動的に作業用の静的コピーを作成して操作できます。
- **柔軟な書き出し**: チャンネル別書き込み（RGBA）、頂点カラーへの焼き込みに対応。
- **インポート設定自動化**: 書き出したテクスチャは自動的に `Read/Write Enabled` と `Streaming Mipmaps` が有効になります。

---

## 基本手順
1. メニューから `Tools > MaskMaker` を開く。
2. ウィンドウ上部の `Target Model` 枠に対象 GameObject をドラッグ＆ドロップ（または Object フィールドで指定）。
   - **自動Work Copy**: デフォルトでは、位置ズレ防止用の作業用コピー（`[WorkCopy]`）が自動生成され、シーンに表示されます。
3. `Analyze UVs` をクリックして UV の解析を実行。
4. シーンビューで対象をクリックしてアイランドを選択。
   - `Add` モードで選択、`Remove` モードで解除。
   - ホットキー（デフォルト `R`）でモード切替（※対象設定時のみ有効）。
5. `Export` セクションで設定を確認し、`Save PNG` でマスクを書き出し。

---

## 各セクションの説明

### Target Model（対象選択）
- **Object**: 対象となる MeshRenderer または SkinnedMeshRenderer を含む GameObject。
- **Auto Work Copy**: ターゲット設定時に、自動的に作業用の複製を作成します（Advanced OptionsでON/OFF可能）。
  - Modular Avatarなどで変形されているメッシュでも、正確な形状でマスクを作成できます。
  - ターゲットをクリア、または別のオブジェクトに変更すると、古い作業用コピーは自動的に削除されます。

### Selection（選択操作）
- **Mode**: クリック時の動作（Add / Remove）。
- **Analyze UVs**: UVレイアウトを解析します。対象を変更した場合やUVチャンネルを変えた場合に実行してください。
- **Invert**: 選択状態を反転。
- **Select All / Clear**: 全選択 / 全解除。

### Export（書き出し）
- **Resolution**: 出力テクスチャサイズ。
- **File Name**: 出力ファイル名。
  - Work Copy使用時でも、ファイル名には元のオブジェクト名が使用されます（`[WorkCopy]` は除外されます）。
- **Output Folder**:保存先フォルダ。
- **Save PNG**: マスク画像を保存します。
- **Channel-wise Write**: 特定のチャンネル（R/G/B/A）のみに書き込む場合に使用します。
  - **Base PNG**: 既存の画像の一部チャンネルだけを上書き更新したい場合に指定します。

### Advanced Options（詳細設定）
- **Scene Overlay**: ワイヤーフレームの太さ、色、Zファイティング対策（Depth Offset）などの表示設定。
- **Channel Write**: グレースケールマスクではなく、特定のチャンネルに書き込む設定。
- **Vertex Color Bake**: 選択範囲を頂点カラーとしてメッシュに焼き込む機能。
- **Preferences**:
  - **Auto Work Copy**: 自動Work Copy生成の有効/無効。
  - **Work Copy Offset**: Work Copyを生成する際の位置オフセット（デフォルト: X+1.5）。
  - **Use English**: UIを英語モードに切り替え。

---

## トラブルシューティング

**Q. メッシュをクリックしても反応しない**
- 対象オブジェクトが正しく設定されているか確認してください。
- 作業用コピーを使っていない場合、コライダーが正しく生成されていない可能性があります。一度 `Analyze UVs` を押し直してみてください。

**Q. SkinnedMeshRendererで表示と判定がズレる**
- `Auto Work Copy` が有効（デフォルト）であれば、静的なコピーが作られるためズレは発生しません。
- Work Copyを使わない場合（設定OFF時）でも、内部的に現在のポーズに合わせた判定を行いますが、極端な変形がある場合はWork Copyの利用を推奨します。

**Q. マスク画像がぼやけている / UVの境界で色が滲む**
- `Pixel Margin` の値を調整してください（デフォルト 2px）。黒領域をわずかに拡張してUVの隙間を埋めます。
